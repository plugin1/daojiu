<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å€’é…’æ¸¸æˆ</title>
<style>
body{font-family: "Segoe UI", "Microsoft YaHei", sans-serif;background:#fafafa;color:#111;padding:16px;}
.container{max-width:900px;margin:auto;background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.06);}
h1{font-size:20px;margin-bottom:8px;}
p.lead{margin:4px 0 18px;color:#555;}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;}
button{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;}
button.primary{background:#0b76ff;color:#fff;border-color:#0b76ff;}
.question-box{margin-bottom:12px;}
.options{display:flex;gap:8px;flex-wrap:wrap;}
.option{flex:1;min-width:140px;border:1px solid #e6e6e6;padding:10px;border-radius:8px;text-align:center;cursor:pointer;background:#fcfcfc;}
.option.chosen{outline:3px solid rgba(11,118,255,.12);}
.small{font-size:13px;color:#666;}
.stats{margin-top:12px;}
textarea{width:100%;min-height:90px;}
footer{margin-top:14px;font-size:12px;color:#777;}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<div class="container">
<h1>å€’é…’æ¸¸æˆ</h1>
<p class="lead">æ¯é¢˜æŠ•ç¥¨åå¯æ˜¾ç¤ºç»“æœï¼Œå¯å¤šäººè”æœºã€‚ç‚¹å‡»é½¿è½®å¯ç¼–è¾‘é¢˜ç›®å’Œé€‰é¡¹ã€‚</p>

<div class="controls">
<button id="prevBtn">â—€ ä¸Šä¸€é¢˜</button>
<button id="nextBtn" class="primary">ä¸‹ä¸€é¢˜ â–¶</button>
<button id="resetQuestion">é‡ç½®æœ¬é¢˜ç¥¨æ•°</button>
<button id="editBtn">âš™ ç¼–è¾‘é¢˜ç›®/é€‰é¡¹</button>
<button id="exportBtn">å¯¼å‡ºæ•°æ®ï¼ˆå¤åˆ¶ï¼‰</button>
<button id="importBtn">å¯¼å…¥æ•°æ®ï¼ˆç²˜è´´ï¼‰</button>
<button id="clearAll">æ¸…ç©ºå…¨éƒ¨æ•°æ®</button>
<button id="unlockVotes" style="font-size:16px;padding:2px 6px;border:none;background:none;cursor:pointer;">ğŸ</button>
</div>

<div class="question-box">
<div class="small">ç¬¬ <span id="qIndex">1</span> / å…± <span id="qCount">0</span> é¢˜</div>
<h2 id="questionTitle">è½½å…¥ä¸­...</h2>
<div class="small" id="optionsHint">é€‰é¡¹å›ºå®šï¼šAï¼šFumika Bï¼šå°ç¾ Cï¼šç›¼ç›¼ Dï¼šSelina Eï¼šZoe</div>
</div>

<div class="options" id="options"></div>

<div class="stats">
<canvas id="chart" height="120"></canvas>
<div class="small" id="summary">æŠ•ç¥¨å°šæœªå¼€å§‹</div>
</div>

<div id="editPanel" style="display:none;margin-top:12px;">
<h3>ç¼–è¾‘é¢˜ç›®ä¸é€‰é¡¹</h3>
<textarea id="editQuestions" placeholder="æ¯è¡Œä¸€ä¸ªé—®é¢˜"></textarea>
<textarea id="editOptions" placeholder="æ¯è¡Œä¸€ä¸ªé€‰é¡¹ï¼Œå¦‚ï¼šFumika"></textarea>
<button id="saveEditBtn">ä¿å­˜ä¿®æ”¹</button>
</div>

<hr>
<textarea id="dataBox" placeholder="å¯¼å‡º/å¯¼å…¥ JSON æ•°æ®"></textarea>

<footer>å€’é…’æ¸¸æˆ</footer>
</div>

<script>
// ========== å¯ç¼–è¾‘é¢˜ç›®ä¸é€‰é¡¹ ==========
let QUESTIONS = [
'è°å‰ä»»æœ€å¤š','è°æœ€çˆ±åœ¨å…¬å…±åœºåˆåšè«åå…¶å¦™çš„äº‹','å‡ºäº‹çš„æ—¶å€™è°æœ€å¯èƒ½å†²åœ¨å‰é¢','è°æœ€å¯èƒ½å…ˆæœ‰å°å­©','è°æœ€å¯èƒ½åœ¨é…’åæ‰¾å‰ä»»è”ç³»','è°æœ€å®¹æ˜“è¢«PUA','è°æœ‰å¯èƒ½æœ€å…ˆç»“å©š','è°æœ€å–œæ¬¢å¼Ÿå¼Ÿ','è°æœ€çˆ±çœ‹å¸…å“¥','è°è®°æ€§æœ€å·®','è°æœ€å¯èƒ½ä¸€å¤œæƒ…','è°æœ€å®¹æ˜“å¿ƒåŠ¨','è°æœ€åƒM','è°æœ€å®¹æ˜“é‡ä¸Šæ¸£ç”·','è°çš„æœ‹å‹æœ€å¤š','è°æœ€æœ‰ä¸Šè¿›å¿ƒ','è°æƒ…ç»ªæœ€ç¨³å®š','è°æœ€æœ‰å¯èƒ½åƒå›å¤´è‰','è°è°ˆæ‹çˆ±è„¾æ°”æœ€å¤§','è°æœ€æœ‰é“å¥³æ½œè´¨','è°æœ€å¯èƒ½ä¸ºçˆ±æ”¾å¼ƒäº‹ä¸š','è°æœ€å…«å¦','è°æ‹çˆ±è„‘æœ€ä¸¥é‡','è°åˆ†æ‰‹åä¼šæœ€å¿«æ‰¾æ–°æ¬¢','è°æœ€å—å¼‚æ€§æ¬¢è¿'
];
let OPTIONS = ['Fumika','å°ç¾','ç›¼ç›¼','Selina','Zoe'];

// ========== çŠ¶æ€ç®¡ç† ==========
let state = loadState();
let qIndex = 0;
const STORAGE_KEY = 'daojiu_votes_v2';
  // æœ¬åœ°æŠ•ç¥¨é™åˆ¶
let votedQuestions = JSON.parse(localStorage.getItem('votedQuestions')||'{}');
function saveVotedQuestions(){ localStorage.setItem('votedQuestions', JSON.stringify(votedQuestions)); }

// DOM
const qCountEl = document.getElementById('qCount');
const qIndexEl = document.getElementById('qIndex');
const questionTitle = document.getElementById('questionTitle');
const optionsDiv = document.getElementById('options');
const summary = document.getElementById('summary');
const dataBox = document.getElementById('dataBox');
const optionsHint = document.getElementById('optionsHint');
const editPanel = document.getElementById('editPanel');
const editQuestions = document.getElementById('editQuestions');
const editOptions = document.getElementById('editOptions');
qCountEl.textContent = QUESTIONS.length;
optionsHint.textContent = 'é€‰é¡¹ï¼š'+OPTIONS.join(' ');

// åˆå§‹åŒ– Firebase
const firebaseConfig = {
apiKey: "AIzaSyB5VcW8kGCWQrhOUV5-sq9NtTKzXHJAl78", 
authDomain: "daojiu-f970e.firebaseapp.com", 
databaseURL: "https://daojiu-f970e-default-rtdb.firebaseio.com",
projectId: "daojiu-f970e", 
storageBucket: "daojiu-f970e.firebasestorage.app", 
messagingSenderId: "438370344777", 
appId: "1:438370344777:web:a2c0f25a6052b339d0c498" 
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Initialize Firebase const app = initializeApp(firebaseConfig);
/*
const firebaseConfig = { ... };
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();
*/

// Chart.js
const ctx = document.getElementById('chart').getContext('2d');
let chart;
function renderChart(counts){
  const labels = OPTIONS.slice();
  if(chart) chart.destroy();
  chart = new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'ç¥¨æ•°',data:counts}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,precision:0}}}});
}

// çŠ¶æ€
function makeEmptyState(){ return {votes:QUESTIONS.map(()=>OPTIONS.map(()=>0)), currentQuestion:0}; }
function loadState(){ try{const raw = localStorage.getItem(STORAGE_KEY);return raw?JSON.parse(raw):makeEmptyState();}catch(e){return makeEmptyState();} }
function saveState(){ localStorage.setItem(STORAGE_KEY,JSON.stringify(state)); }

// æ˜¾ç¤ºé¢˜ç›®ï¼ˆæ”¯æŒ Firebase Realtime Database å®æ—¶æ›´æ–°ï¼‰
function showQuestion(idx){
  qIndex = idx;
  qIndexEl.textContent = idx + 1;
  questionTitle.textContent = QUESTIONS[idx] || 'é¢˜ç›®ç¼ºå¤±';
  optionsDiv.innerHTML = '';

  // è·å–å½“å‰é¢˜ç›®çš„æ•°æ®åº“å¼•ç”¨
  const voteRef = db.ref(`votes/${idx}`);

  // å…ˆè§£ç»‘æ—§ç›‘å¬ï¼Œé˜²æ­¢é‡å¤ç»‘å®š
  voteRef.off();

  // ç›‘å¬æ•°æ®åº“å˜åŒ–
  voteRef.on('value', snapshot => {
    const counts = snapshot.val() || OPTIONS.map(() => 0);

    // æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼Œä¿è¯å¯¼å‡º/å¯¼å…¥ä¸€è‡´
    state.votes[idx] = counts;
    saveState();

    // æ¸²æŸ“é€‰é¡¹æŒ‰é’®
    optionsDiv.innerHTML = '';
    counts.forEach((c, i) => {
      const btn = document.createElement('div');
      btn.className = 'option';
      btn.dataset.idx = i;
      btn.innerHTML = `<div style="font-weight:600">${OPTIONS[i]}</div><div class="small">ç‚¹å‡»æŠ•ç¥¨</div>`;

  // å¦‚æœå·²æŠ•ç¥¨æœ¬é¢˜ï¼ŒæŒ‰é’®ä¸å¯ç‚¹
      if(votedQuestions[idx]){
        btn.style.opacity = 0.6;
        btn.style.pointerEvents = 'none';
        btn.querySelector('.small').textContent = 'å·²æŠ•ç¥¨';
      } else {
        btn.addEventListener('click', () => { submitVote(i); });
      }

      optionsDiv.appendChild(btn);
    });

    // æ¸²æŸ“å›¾è¡¨å’Œæ€»ç¥¨æ•°
    renderChart(counts);
    const total = counts.reduce((a, b) => a + b, 0);
    summary.textContent = `æ€»ç¥¨æ•°ï¼š${total}ï¼ˆ${counts.map((c,i)=>OPTIONS[i]+':'+c).join(' ï¼ ')}ï¼‰`;
  });
}

// æŠ•ç¥¨
function submitVote(optionIdx){
  if(votedQuestions[qIndex]){
    alert('ä½ å·²ç»æŠ•è¿‡è¿™é¢˜äº†ï¼Œæ¯é¢˜åªèƒ½æŠ•ä¸€æ¬¡');
    return;
  }

  // æ›´æ–°æœ¬åœ°çŠ¶æ€
  state.votes[qIndex][optionIdx] += 1;
  saveState();

  // æ›´æ–°æ•°æ®åº“
  const votePath = `votes/${qIndex}/${optionIdx}`;
  db.ref(votePath).transaction(current => {
    return (current || 0) + 1;
  });

  // æ ‡è®°å·²æŠ•ç¥¨
  votedQuestions[qIndex] = true;
  saveVotedQuestions();
}



// Buttons
document.getElementById('nextBtn').addEventListener('click',()=>{ if(qIndex<QUESTIONS.length-1) qIndex++; showQuestion(qIndex); });
document.getElementById('prevBtn').addEventListener('click',()=>{ if(qIndex>0) qIndex--; showQuestion(qIndex); });
document.getElementById('resetQuestion').addEventListener('click',()=>{ 
  if(confirm('ç¡®å®šé‡ç½®æœ¬é¢˜ç¥¨æ•°å—ï¼Ÿ')){ 
    state.votes[qIndex]=OPTIONS.map(()=>0); 
    saveState(); 
    // Firebase åŒæ­¥
    db.ref(`votes/${qIndex}`).set(OPTIONS.map(()=>0));
    // åŒæ­¥æ¸…é™¤æœ¬åœ°æŠ•ç¥¨æ ‡è®°
    delete votedQuestions[qIndex]; 
    saveVotedQuestions();
    showQuestion(qIndex); 
  } 
});

document.getElementById('clearAll').addEventListener('click',()=>{ 
  if(confirm('ç¡®å®šæ¸…ç©ºå…¨éƒ¨æ•°æ®ï¼Ÿ')){ 
    state=makeEmptyState(); 
    saveState(); 
    // Firebase åŒæ­¥
    QUESTIONS.forEach((_, idx) => db.ref(`votes/${idx}`).set(OPTIONS.map(()=>0)));
    // æ¸…é™¤æœ¬åœ°æŠ•ç¥¨æ ‡è®°
    votedQuestions = {}; 
    saveVotedQuestions();
    showQuestion(0); 
  } 
});


// å¯¼å‡º/å¯¼å…¥
document.getElementById('exportBtn').addEventListener('click', () => {
  dataBox.value = JSON.stringify(state);
  dataBox.select();
  try {
    document.execCommand('copy');
    alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¯å‘ç»™å…¶ä»–äººåŒæ­¥');
  } catch (e) {
    alert('è¯·æ‰‹åŠ¨å¤åˆ¶å³æ–¹æ–‡æœ¬');
  }
});

document.getElementById('importBtn').addEventListener('click', () => {
  const raw = dataBox.value.trim();
  if (!raw) { 
    alert('è¯·å…ˆç²˜è´´ JSON æ•°æ®'); 
    return; 
  }
  try {
    const obj = JSON.parse(raw);
    if (!obj.votes || !Array.isArray(obj.votes) || obj.votes.length !== QUESTIONS.length) throw 'æ ¼å¼é”™è¯¯';
    state = obj; 
    saveState(); 
    showQuestion(qIndex); 
    alert('å·²å¯¼å…¥æ•°æ®'); 
  } catch(e) {
    alert('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ JSON æ ¼å¼');
  }
});

// ğŸ æµ‹è¯•æŒ‰é’®ï¼šè§£é”æœ¬åœ°æŠ•ç¥¨ï¼ˆä»…æµ‹è¯•ç”¨ï¼Œä¸æ˜¾çœ¼ï¼‰
document.getElementById('unlockVotes').addEventListener('click', () => {
  votedQuestions = {};
  saveVotedQuestions();
  alert('æœ¬åœ°æŠ•ç¥¨å·²è§£é”ï¼Œå¯ä»¥å†æ¬¡æŠ•ç¥¨ï¼ˆæµ‹è¯•ç”¨ï¼‰');
  showQuestion(qIndex);
});

// ç¼–è¾‘é¢˜ç›®/é€‰é¡¹
document.getElementById('editBtn').addEventListener('click',()=>{ editPanel.style.display=editPanel.style.display==='none'?'block':'none'; editQuestions.value=QUESTIONS.join('\n'); editOptions.value=OPTIONS.join('\n'); });
document.getElementById('saveEditBtn').addEventListener('click',()=>{
  const qText = editQuestions.value.split('\n').map(l=>l.trim()).filter(Boolean);
  const oText = editOptions.value.split('\n').map(l=>l.trim()).filter(Boolean);
  if(qText.length<1||oText.length<1){ alert('é¢˜ç›®å’Œé€‰é¡¹éƒ½ä¸èƒ½ä¸ºç©º'); return; }
  QUESTIONS=qText; OPTIONS=oText;
  // è°ƒæ•´ votes
  state.votes=QUESTIONS.map((q,i)=>state.votes[i]||OPTIONS.map(()=>0));
  qCountEl.textContent=QUESTIONS.length;
  optionsHint.textContent='é€‰é¡¹ï¼š'+OPTIONS.join(' ');
  saveState();
  showQuestion(0);
});

// åˆå§‹åŒ–
showQuestion(0);
</script>
</body>
</html>
